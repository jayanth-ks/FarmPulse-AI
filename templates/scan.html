<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Plant - FarmPulse AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-8">
                    <span class="text-2xl font-bold text-green-600">ðŸŒ± FarmPulse AI</span>
                    <div class="hidden md:flex space-x-4">
                        <a href="/dashboard" class="px-3 py-2 text-gray-600 hover:text-gray-900">Dashboard</a>
                        <a href="/scan" class="px-3 py-2 text-green-600 font-medium border-b-2 border-green-600">Scan</a>
                        <a href="/history" class="px-3 py-2 text-gray-600 hover:text-gray-900">History</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/api/docs" class="text-gray-600 hover:text-gray-900">
                        <i class="fas fa-book"></i>
                    </a>
                    <a href="/logout" class="px-4 py-2 text-red-600 hover:text-red-700 font-medium">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Scan Your Plant ðŸ“¸</h1>
            <p class="text-gray-600">Upload an image or take a photo to detect plant diseases</p>
        </div>

        <!-- Upload Section -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-green-500 transition duration-200 cursor-pointer" id="uploadArea">
                <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                <p class="text-xl font-semibold text-gray-700 mb-2">Drop your image here or click to browse</p>
                <p class="text-sm text-gray-500 mb-4">Supports: JPG, PNG (Max 10MB)</p>
                <input type="file" id="fileInput" accept="image/*" class="hidden">
                <div class="flex justify-center space-x-4 mt-4">
                    <button onclick="document.getElementById('fileInput').click()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-file-upload mr-2"></i>Choose File
                    </button>
                    <button onclick="document.getElementById('cameraInput').click()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-camera mr-2"></i>Take Photo
                    </button>
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>
                </div>
            </div>

            <!-- Preview -->
            <div id="previewSection" class="mt-6 hidden">
                <img id="preview" class="max-w-full h-auto rounded-lg shadow-lg mx-auto" style="max-height: 400px;">
                <div class="mt-4 flex justify-center space-x-4">
                    <button id="analyzeBtn" class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold shadow-lg">
                        <i class="fas fa-brain mr-2"></i>Analyze with AI
                    </button>
                    <!-- <button id="predictBtn" class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold shadow-lg">
                        <i class="fas fa-chart-line mr-2"></i>Model Prediction
                    </button> -->
                </div>
            </div>

            <!-- Loading -->
            <div id="loading" class="mt-6 text-center hidden">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mb-4"></div>
                <p class="text-gray-600">Analyzing your plant...</p>
            </div>

            <!-- Results -->
            <div id="results" class="mt-6 hidden"></div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg">
        <div class="grid grid-cols-3 max-w-md mx-auto">
            <a href="/dashboard" class="flex flex-col items-center justify-center py-3 text-green-600">
                <i class="fas fa-seedling text-xl mb-1"></i>
                <span class="text-xs font-medium">Dashboard</span>
            </a>
            <a href="/scan" class="flex flex-col items-center justify-center py-3 text-gray-400 hover:text-gray-600">
                <i class="fas fa-camera text-xl mb-1"></i>
                <span class="text-xs">Scan</span>
            </a>
            <a href="/history" class="flex flex-col items-center justify-center py-3 text-gray-400 hover:text-gray-600">
                <i class="fas fa-history text-xl mb-1"></i>
                <span class="text-xs">History</span>
            </a>
        </div>
    </nav>
    
    <script>
        const fileInput = document.getElementById('fileInput');
        const cameraInput = document.getElementById('cameraInput');
        const uploadArea = document.getElementById('uploadArea');
        const preview = document.getElementById('preview');
        const previewSection = document.getElementById('previewSection');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const predictBtn = document.getElementById('predictBtn');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');

        let selectedFile = null;

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-green-500', 'bg-green-50');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('border-green-500', 'bg-green-50');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-green-500', 'bg-green-50');
            handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        cameraInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    previewSection.classList.remove('hidden');
                    results.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        analyzeBtn.addEventListener('click', () => analyze('/api/analyze'));
        // predictBtn.addEventListener('click', () => analyze('/api/predict'));

        async function analyze(endpoint) {
            if (!selectedFile) {
                displayError('Please select an image first');
                return;
            }

            const formData = new FormData();
            formData.append('file', selectedFile);

            loading.classList.remove('hidden');
            results.classList.add('hidden');
            analyzeBtn.disabled = true;
            // predictBtn.disabled = true;

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    displayResults(data, endpoint);
                } else {
                    displayError(data.error || 'An error occurred');
                }
            } catch (error) {
                console.error('Analysis error:', error);
                displayError('Failed to connect to server: ' + error.message);
            } finally {
                loading.classList.add('hidden');
                analyzeBtn.disabled = false;
                // predictBtn.disabled = false;
            }
        }

        function displayResults(data, endpoint) {
            let html = '<div class="bg-white rounded-lg shadow-lg p-6">';

            if (endpoint === '/api/analyze') {
                if (data.disease_detected === false) {
                    html += `
                        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-3xl text-green-600 mr-4"></i>
                                <div>
                                    <h3 class="text-xl font-bold text-green-900">Healthy Plant! ðŸŽ‰</h3>
                                    <p class="text-green-700">Confidence: ${data.confidence}%</p>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div><span class="font-semibold">Crop Type:</span> ${data.crop_type || 'Unknown'}</div>
                            <div class="text-gray-700">${data.message}</div>
                        </div>
                    `;
                } else {
                    const severityColors = {
                        'Low': 'yellow',
                        'Medium': 'orange',
                        'High': 'red'
                    };
                    const color = severityColors[data.severity] || 'gray';
                    
                    html += `
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-exclamation-triangle text-3xl text-red-600 mr-4"></i>
                                    <div>
                                        <h3 class="text-xl font-bold text-red-900">${data.disease_name}</h3>
                                        <p class="text-red-700">Confidence: ${data.confidence}%</p>
                                    </div>
                                </div>
                                <span class="px-3 py-1 bg-${color}-100 text-${color}-800 rounded-full text-sm font-semibold">${data.severity}</span>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <p class="font-semibold text-gray-900 mb-1">Crop Type:</p>
                                <p class="text-gray-700">${data.crop_type || 'Unknown'}</p>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 mb-1">Probable Cause:</p>
                                <p class="text-gray-700">${data.probable_cause}</p>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 mb-1">Description:</p>
                                <p class="text-gray-700">${data.description}</p>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 mb-1">Treatment Solution:</p>
                                <p class="text-gray-700">${data.solution}</p>
                            </div>
                        </div>
                    `;
                }
            } else {
                html += `
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Model Predictions</h3>
                    <div class="space-y-3">
                        ${data.top_predictions.map((pred, i) => `
                            <div class="flex items-center justify-between p-3 ${i === 0 ? 'bg-green-50 border-l-4 border-green-500' : 'bg-gray-50'} rounded-lg">
                                <span class="font-medium">${pred.class.replace(/_/g, ' ')}</span>
                                <span class="font-bold text-green-600">${(pred.confidence * 100).toFixed(1)}%</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            html += '</div>';
            results.innerHTML = html;
            results.classList.remove('hidden');
        }

        function displayError(message) {
            results.innerHTML = `
                <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-red-600 mr-3"></i>
                        <p class="text-red-800">${message}</p>
                    </div>
                </div>
            `;
            results.classList.remove('hidden');
        }
    </script>
</body>
</html>
